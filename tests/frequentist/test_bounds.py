import pytest
import time
import numpy as np

from spotify_confidence.analysis.frequentist.confidence_computers.z_test_computer import sequential_bounds

# @pytest.mark.skip(reason="Skipping because this test is very slow")
def test_many_days():
    """
    This input (based on a real experiment) is very long, which can cause slow calculation
    """

    t = [
        0.0016169976338740648,
        0.0057857955498163615,
        0.012200379088315757,
        0.020199591701142824,
        0.02956441064038571,
        0.04047102718841871,
        0.052929825413405296,
        0.06580092295219643,
        0.07878439818310792,
        0.09148496950057272,
        0.1028893343050959,
        0.1128434997940756,
        0.12298934256730025,
        0.13280979910049193,
        0.14267997977787195,
        0.15281963941289514,
        0.16293176212095561,
        0.17198778455162406,
        0.17996747917082068,
        0.18786110540725684,
        0.1955669737257397,
        0.20335013690301407,
        0.21277055903588274,
        0.22148328777708232,
        0.2295912740670489,
        0.23640586948077766,
        0.2431234831038822,
        0.24987292468428604,
        0.2568336065927525,
        0.2649271880853427,
        0.27282722271091664,
        0.2799894816822785,
        0.2862801096305317,
        0.2925685639072496,
        0.2988294699944579,
        0.3051314956400879,
        0.3118994077972684,
        0.31887303037202536,
        0.32523581745772245,
        0.3307398353487736,
        0.33616198578702633,
        0.34151324975562525,
        0.3478405485563082,
        0.3546238566149848,
        0.36130761502236336,
        0.36751189302418574,
        0.3730571543616735,
        0.37865278180851814,
        0.38428987795273567,
        0.3900127609160433,
        0.3964718089893684,
        0.40306122104207753,
        0.40914555292031984,
        0.41449831480764515,
        0.4198849769608837,
        0.4256404199470336,
        0.4315384355133149,
        0.43801594290086987,
        0.4444516211895538,
        0.45034373518130405,
        0.4556807858158224,
        0.4610488197166289,
        0.46633036852044285,
        0.4717294082126311,
        0.47769497653470894,
        0.48369759863580825,
        0.4892945325380834,
        0.49431792124380325,
        0.49935417177798586,
        0.5043009639028166,
        0.5093262559789482,
        0.5149098888134348,
        0.5205835093969735,
        0.5261172491490695,
        0.5310141031413226,
        0.5359027242118537,
        0.540068909216935,
        0.5451620919252675,
        0.5506752550043325,
        0.5562355968920056,
        0.5614758121490083,
        0.5660462437469214,
        0.5706616804819072,
        0.5750453002157994,
        0.5795939049979849,
        0.5861802311128667,
        0.5913273051077091,
        0.5958976691303413,
        0.6001503392324151,
        0.6042404457337608,
        0.6082963816680697,
        0.6124734913435614,
        0.6174918231657613,
        0.6223867287374153,
        0.6268875352709179,
        0.6308341907134806,
        0.6348490070893678,
        0.6388763812049537,
        0.6430405276890614,
        0.6476616520101889,
        0.6525750168960728,
        0.6570689758011117,
        0.6610427627189518,
        0.6649727383296814,
        0.6689671694958335,
        0.673019050913289,
        0.6776959248411508,
        0.6825336054124376,
        0.6869984168463193,
        0.6908780826604262,
        0.6949984065748767,
        0.6991746490342636,
        0.7033415661048878,
        0.7082721626873987,
        0.7131064081819068,
        0.7176506656210218,
        0.7216193168175142,
        0.7256178250256133,
        0.7296113326629264,
        0.733677461202103,
        0.7383860054116087,
        0.7431864069529378,
        0.7475115177561259,
        0.7513220765829758,
        0.7551652404828552,
        0.7591154774153049,
        0.7635879699061145,
        0.76888963361854,
        0.7740750002725536,
        0.7788235152607059,
        0.7829338267710377,
        0.7870690059847372,
        0.7912444713283939,
        0.7954864645360872,
        0.8002680350991415,
        0.8051864906561857,
        0.8097254772233912,
        0.8137210008565843,
        0.8175460095309978,
        0.8214444612731922,
        0.8256005212486867,
        0.8302889054993935,
        0.8351108860804202,
        0.839542135124793,
        0.8433705788759852,
        0.8472835029908369,
        0.8513248314019267,
        0.8556693700983707,
        0.8606610209471658,
        0.865499591259651,
        0.8699232042972833,
        0.8737653545679493,
        0.8776996212090155,
        0.8816179062961511,
        0.8856027192473231,
        0.8900849425785808,
        0.8947120585746139,
        0.8993599427069738,
        0.9035026227768521,
        0.9075820073336299,
        0.9115699850604569,
        0.9158137239629064,
        0.9207252417911126,
        0.925749689176233,
        0.9303560370359392,
        0.9343408161994707,
        0.9384800274049299,
        0.9426168396879175,
        0.9475247422385961,
        0.9523909621035122,
        0.9573336433987555,
        0.9618665256655873,
        0.9657568345864344,
        0.9697355995499667,
        0.973736889607129,
        0.9778353641807583,
        0.9828378833872299,
        0.987703190985854,
        0.9921586319807856,
        0.9960384779956415,
        1.0,
    ]

    start_time = time.time()
    my_bounds = sequential_bounds(np.array(t), alpha=0.003333333, sides=2).bounds

    # if the calculation with max_nints takes longer than 10 seconds, something is most likely broken
    assert (time.time() - start_time) < 10


# @pytest.mark.skip(reason="Skipping because this test is very slow")
def test_many_days_fast_and_no_crash():
    """
    This is based on experiment 1735 on 26.11.2020. The calculation of the corresponding bounds takes many minutes
    without performance tweak. Therefore, this test only checks for absence of crashs and time constraints, but
    does not compare against the baseline without performance tweak. There is a Jupyter notebook making that comparison.
    """

    t = [
        0.011404679673257933,
        0.02292450819418779,
        0.0356455988484443,
        0.04835740420885424,
        0.05971666577058213,
        0.06976017458481187,
        0.07984165086754545,
        0.09002459314412276,
        0.10026356929804565,
        0.11129746744100509,
        0.1222487922920801,
        0.13250332796555583,
        0.1418309168157694,
        0.15072692856918676,
        0.15940425274581055,
        0.16819162796171988,
        0.17766544268380677,
        0.18725283769713902,
        0.19600162922594835,
        0.20386600701959812,
        0.21159934032678884,
        0.21916233120704773,
        0.22688560894714668,
        0.23509036348536208,
        0.24366994698965522,
        0.2515994198750076,
        0.25875219123481424,
        0.2659624389836802,
        0.2731790169781248,
        0.28051081384508175,
        0.28822790138928306,
        0.2962915558739476,
        0.3037246366701631,
        0.31063411372423433,
        0.31767205835063517,
        0.32464032826076655,
        0.3318100596369355,
        0.3397812253123048,
        0.3476375502493003,
        0.3550356746451523,
        0.3616457394863339,
        0.3683042335071859,
        0.375005792804928,
        0.38175551518794676,
        0.3891222824602354,
        0.39652683513644266,
        0.40347332732118724,
        0.4098512458112366,
        0.4163205187081655,
        0.42263992444151655,
        0.42899148558161226,
        0.43464157988476515,
        0.43858871208254674,
        0.44192382717460427,
        0.44482627278235426,
        0.4474605932759375,
        0.44957511937869815,
        0.4509048070694502,
        0.45222422911858906,
        0.45333747002744257,
        0.45426598540713137,
        0.4551955091445229,
        0.45605329943533507,
        0.456895460181754,
        0.4578387508027823,
        0.45881449093488524,
        0.45965707183034693,
        0.4603621239391219,
        0.4610501740166303,
        0.46173166976907054,
        0.4624475477181825,
        0.4632872155802805,
        0.4641010162663083,
        0.46481571779810027,
        0.4654194019478082,
        0.4660207332628762,
        0.4666458170038323,
        0.4672646265190821,
        0.46791675385342846,
        0.4685898046101078,
        0.46918687841487516,
        0.46969451649339183,
        0.47019581032136176,
        0.4706811945055765,
        0.47116992587716583,
        0.47170379526092326,
        0.47227291514937425,
        0.4727852448922026,
        0.47322669549150526,
        0.4736554715946826,
        0.47408022827201673,
        0.47450655350577753,
        0.4749737592414058,
        0.47545756086422586,
        0.4759381553493523,
        0.47630259262910407,
        0.4766609657576709,
        0.47699441004302984,
        0.4773518028238301,
        0.477775327063972,
        0.4781977729215707,
        0.47856485714029223,
        0.47888037506649034,
        0.47919262983512245,
        0.47949520717080135,
        0.47980748994936967,
        0.4801789017032324,
        0.4805627078538587,
        0.48090167009664675,
        0.4811904245288165,
        0.48149113920373887,
        0.4817901452725537,
        0.4820966860142033,
        0.48243977972257923,
        0.4827841618880198,
        0.48309197708176604,
        0.4833586316742829,
        0.4836129058750043,
        0.4838654994795544,
        0.4841171547512422,
        0.48439948090305657,
        0.48470691796266424,
        0.4849764575786085,
        0.4852081697757299,
        0.48545255646897667,
        0.4856974893559792,
        0.48595208567096676,
        0.48624575584693763,
        0.4865416528128355,
        0.4867930840050338,
        0.4870117575768593,
        0.4872274340855126,
        0.4874240218226533,
        0.4876215198827202,
        0.4878617751103791,
        0.488108108494191,
        0.48831807097586183,
        0.4884937072807334,
        0.48866595438332605,
        0.488852192449045,
        0.48903411698459087,
        0.4892522303576926,
        0.4894829201921431,
        0.4896802221826566,
        0.4898457609055321,
        0.49001188783706756,
        0.4901847091433521,
        0.4903469286887892,
        0.4905345812562857,
        0.49073597269748276,
        0.49091467609036693,
        0.4910691508884479,
        0.4912115954189357,
        0.49135658885361677,
        0.49150574176382184,
        0.49167835299558493,
        0.49186735004001847,
        0.49203167033066975,
        0.49216849886895175,
        0.4923075682021289,
        0.4924506289512129,
        0.49259525825672346,
        0.49276396210238826,
        0.49294465420074185,
        0.4931019580023778,
        0.49330306934421303,
        0.4935200763248353,
        0.49373208353184794,
        0.4939721566949216,
        0.4942334053697541,
        0.4944958444668745,
        0.4947262121870588,
        0.49492469059489225,
        0.4951192336066912,
        0.495294323717807,
        0.4954780829041733,
        0.4956838158854796,
        0.49592192835302007,
        0.49614550366367866,
        0.49633301618149417,
        0.49652995404283723,
        0.4967104500716375,
        0.4969174855149766,
        0.49712443692850716,
        0.4973541744251272,
        0.49756258235533957,
        0.49772464784612763,
        0.4978989396740621,
        0.4980669292663541,
        0.4982378038820735,
        0.49843929335804726,
        0.4986487236509305,
        0.49883442952786183,
        0.49899118713574214,
        0.49915640374435144,
        0.49932506557511197,
    ]

    alpha = 0.0033333333333333335
    sides = 2

    start_time = time.time()
    sequential_bounds(np.array(t), alpha=alpha, sides=sides).bounds

    # if the calculation with max_nints takes longer than 30 seconds, something is most likely broken
    assert (time.time() - start_time) < 30
